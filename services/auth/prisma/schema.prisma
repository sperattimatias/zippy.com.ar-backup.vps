generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

model User {
  id                 String                  @id @default(cuid())
  email              String                  @unique
  password_hash      String
  email_verified_at  DateTime?
  status             UserStatus              @default(ACTIVE)
  created_at         DateTime                @default(now())
  updated_at         DateTime                @updatedAt
  roles              UserRole[]
  verificationCodes  EmailVerificationCode[]
  refreshTokens      RefreshToken[]
}

model Role {
  id    String     @id @default(cuid())
  name  String     @unique
  users UserRole[]
}

model UserRole {
  user_id String
  role_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role    Role   @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
}

model EmailVerificationCode {
  id         String   @id @default(cuid())
  user_id    String
  code_hash  String
  expires_at DateTime
  attempts   Int      @default(0)
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, expires_at])
}

model RefreshToken {
  id                    String        @id @default(cuid())
  user_id               String
  token_hash            String
  created_at            DateTime      @default(now())
  expires_at            DateTime
  revoked_at            DateTime?
  replaced_by_token_id  String?
  user_agent            String?
  ip                    String?
  user                  User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  replacedBy            RefreshToken? @relation("RefreshTokenReplacement", fields: [replaced_by_token_id], references: [id])
  replaces              RefreshToken[] @relation("RefreshTokenReplacement")

  @@index([user_id])
  @@index([token_hash])
}
