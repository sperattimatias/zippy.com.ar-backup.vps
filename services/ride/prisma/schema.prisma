generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TripStatus {
  DRAFT
  REQUESTED
  BIDDING
  MATCHED
  DRIVER_EN_ROUTE
  ARRIVED
  OTP_PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_PASSENGER
  CANCELLED_BY_DRIVER
  EXPIRED_NO_DRIVER
}

enum CancelReason {
  PASSENGER_CHANGED_MIND
  DRIVER_NO_SHOW
  PASSENGER_NO_SHOW
  PRICE_DISAGREE
  SAFETY
  OTHER
}

enum TripBidStatus {
  PENDING
  WITHDRAWN
  ACCEPTED
  REJECTED
  AUTO_SELECTED
}

enum VehicleCategory {
  MOTO
  AUTO
}

enum TripActor {
  DRIVER
  PASSENGER
}

enum GeoZoneType {
  SAFE
  CAUTION
  RED
}

enum SafetyAlertType {
  ENTERED_RED_ZONE
  ENTERED_CAUTION_ZONE
  ROUTE_DEVIATION_MAJOR
  ROUTE_DEVIATION_MINOR
  TRACKING_LOST
  OTP_FAILED_MULTIPLE
  DRIVER_CANCEL_PATTERN
  PASSENGER_CANCEL_PATTERN
  MANUAL_SOS_TRIGGER
}

enum SafetyAlertStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

enum DeviationLevel {
  NONE
  MINOR
  MAJOR
}

enum ActorType {
  DRIVER
  PASSENGER
}

enum ScoreEventType {
  TRIP_COMPLETED_CLEAN
  DRIVER_CANCEL_LATE
  PASSENGER_CANCEL_LATE
  DRIVER_NO_SHOW
  PASSENGER_NO_SHOW
  ENTERED_RED_ZONE
  ROUTE_DEVIATION_MAJOR
  ROUTE_DEVIATION_MINOR
  TRACKING_LOST_MAJOR
  OTP_FAILED_MULTIPLE
  MANUAL_ADJUST
  TRIP_RECOVERY_BONUS
}

enum RestrictionStatus {
  NONE
  WARNING
  LIMITED
  BLOCKED
}

enum RestrictionReason {
  LOW_SCORE_AUTO
  SAFETY_PATTERN
  FRAUD_PATTERN
  MANUAL_ADMIN
}

enum PremiumZoneType {
  PREMIUM
  EVENT
  TERMINAL
  HIGH_DEMAND
}

enum BadgeTier {
  EXCELLENT
  TRUSTED
  WATCHLIST
  RESTRICTED
}


enum LevelTier {
  BRONZE
  SILVER
  GOLD
  DIAMOND
}

enum PeriodStatus {
  DRAFT
  FINALIZED
}

enum BonusType {
  COMMISSION_DISCOUNT
}

enum BonusStatus {
  ACTIVE
  EXPIRED
  REVOKED
}


enum FraudSignalType {
  REPEATED_PAIR_TRIPS
  HIGH_VELOCITY_TRIPS
  HIGH_VELOCITY_PAYMENTS
  SHARED_IP_MULTIPLE_USERS
  SHARED_DEVICE_FINGERPRINT
  MULTIPLE_ACCOUNTS_SAME_DRIVER
  EXCESSIVE_REFUNDS
  REFUND_VELOCITY_HIGH
  REFUND_RATIO_HIGH
  PAYMENT_REJECT_RATE_HIGH
  SUSPICIOUS_ROUTE_PATTERN
  MANUAL_REVIEW_TRIGGER
  RISK_DECAY
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudCaseStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  DISMISSED
}

enum HoldType {
  PAYOUT_HOLD
  FEATURE_LIMIT
  ACCOUNT_BLOCK
}

enum HoldStatus {
  ACTIVE
  RELEASED
  EXPIRED
}

model Trip {
  id                    String       @id @default(cuid())
  passenger_user_id     String
  driver_user_id        String?
  status                TripStatus   @default(DRAFT)
  origin_lat            Float
  origin_lng            Float
  origin_address        String
  dest_lat              Float
  dest_lng              Float
  dest_address          String
  distance_km           Float?
  eta_minutes           Int?
  price_base            Int
  price_final           Int?
  currency              String       @default("ARS")
  bidding_expires_at    DateTime?
  matched_at            DateTime?
  started_at            DateTime?
  completed_at          DateTime?
  cancelled_at          DateTime?
  cancelled_by_user_id  String?
  cancel_reason         CancelReason?
  created_at            DateTime     @default(now())
  updated_at            DateTime     @updatedAt

  bids TripBid[]
  locations TripLocation[]
  events TripEvent[]
  otp TripOTP?
  safety_state TripSafetyState?
  route_baseline TripRouteBaseline?
  safety_alerts SafetyAlert[]

  @@index([passenger_user_id, created_at])
  @@index([driver_user_id, created_at])
  @@index([status, bidding_expires_at])
}

model TripBid {
  id                     String        @id @default(cuid())
  trip_id                String
  driver_user_id         String
  price_offer            Int
  eta_to_pickup_minutes  Int?
  status                 TripBidStatus @default(PENDING)
  created_at             DateTime      @default(now())

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id])
  @@index([driver_user_id])
  @@index([trip_id, price_offer])
}

model DriverPresence {
  driver_user_id   String          @id
  is_online        Boolean         @default(false)
  last_lat         Float?
  last_lng         Float?
  last_seen_at     DateTime?
  vehicle_category VehicleCategory
  is_limited       Boolean         @default(false)

  @@index([is_online, last_seen_at])
}

model TripLocation {
  id         String    @id @default(cuid())
  trip_id    String
  actor      TripActor
  lat        Float
  lng        Float
  speed      Float?
  heading    Float?
  created_at DateTime  @default(now())

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id, created_at])
}

model TripEvent {
  id            String   @id @default(cuid())
  trip_id       String
  actor_user_id String?
  type          String
  payload_json  Json
  created_at    DateTime @default(now())

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id, created_at])
}

model TripOTP {
  trip_id     String   @id
  otp_hash    String
  expires_at  DateTime
  attempts    Int      @default(0)
  verified_at DateTime?

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)
}

model GeoZone {
  id          String      @id @default(cuid())
  name        String
  type        GeoZoneType
  polygon_json Json
  is_active   Boolean     @default(true)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  @@index([type, is_active])
}

model TripRouteBaseline {
  trip_id        String   @id
  polyline_json  Json
  created_at     DateTime @default(now())

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)
}

model TripSafetyState {
  trip_id                  String         @id
  safety_score             Int            @default(100)
  last_driver_location_at  DateTime?
  last_zone_type           GeoZoneType?
  deviation_level          DeviationLevel @default(NONE)
  created_at               DateTime       @default(now())
  updated_at               DateTime       @updatedAt

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)
}

model SafetyAlert {
  id                        String            @id @default(cuid())
  trip_id                   String
  type                      SafetyAlertType
  status                    SafetyAlertStatus @default(OPEN)
  severity                  Int
  message                   String
  payload_json              Json
  created_at                DateTime          @default(now())
  acknowledged_at           DateTime?
  acknowledged_by_user_id   String?
  resolved_at               DateTime?
  resolved_by_user_id       String?

  trip Trip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([status, created_at])
}


model UserScore {
  id              String            @id @default(cuid())
  user_id         String
  actor_type      ActorType
  score           Int               @default(100)
  status          RestrictionStatus @default(NONE)
  last_changed_at DateTime          @default(now())
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  events ScoreEvent[]
  restrictions UserRestriction[]

  @@unique([user_id, actor_type])
  @@index([actor_type, status])
  @@index([score])
}

model ScoreEvent {
  id              String         @id @default(cuid())
  user_id         String
  actor_type      ActorType
  type            ScoreEventType
  delta           Int
  trip_id         String?
  safety_alert_id String?
  payload_json    Json
  created_at      DateTime       @default(now())

  score UserScore @relation(fields: [user_id, actor_type], references: [user_id, actor_type], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([trip_id])
}

model UserRestriction {
  id                 String            @id @default(cuid())
  user_id            String
  actor_type         ActorType
  status             RestrictionStatus
  reason             RestrictionReason
  starts_at          DateTime
  ends_at            DateTime?
  created_by_user_id String?
  notes              String?
  created_at         DateTime          @default(now())

  score UserScore @relation(fields: [user_id, actor_type], references: [user_id, actor_type], onDelete: Cascade)

  @@index([user_id, ends_at])
  @@index([status])
}


model AppConfig {
  key        String   @id
  value_json Json
  updated_at DateTime @updatedAt
}

model PremiumZone {
  id                 String          @id @default(cuid())
  name               String
  type               PremiumZoneType
  polygon_json       Json
  is_active          Boolean         @default(true)
  min_driver_score   Int             @default(75)
  min_passenger_score Int            @default(60)
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt

  @@index([type, is_active])
}

model UserBadge {
  id         String    @id @default(cuid())
  user_id    String
  actor_type ActorType
  tier       BadgeTier
  label      String
  updated_at DateTime  @updatedAt

  @@unique([user_id, actor_type])
}

model PeakGateEvent {
  id         String    @id @default(cuid())
  user_id    String
  actor_type ActorType
  allowed    Boolean
  reason     String
  created_at DateTime  @default(now())

  @@index([user_id, created_at])
}


model UserLevel {
  id          String    @id @default(cuid())
  user_id     String
  actor_type  ActorType
  tier        LevelTier
  computed_at DateTime
  valid_until DateTime?
  payload_json Json
  created_at  DateTime  @default(now())

  @@unique([user_id, actor_type])
}

model UserLevelHistory {
  id          String    @id @default(cuid())
  user_id     String
  actor_type  ActorType
  tier        LevelTier
  computed_at DateTime
  payload_json Json
  created_at  DateTime  @default(now())

  @@index([user_id, created_at])
}

model MonthlyPerformance {
  id                    String       @id @default(cuid())
  user_id               String
  actor_type            ActorType
  year                  Int
  month                 Int
  trips_completed       Int          @default(0)
  trips_cancelled_late  Int          @default(0)
  no_show_count         Int          @default(0)
  avg_score             Int          @default(100)
  safety_major_alerts   Int          @default(0)
  completion_rate       Float        @default(0)
  cancel_rate           Float        @default(0)
  performance_index     Float        @default(0)
  status                PeriodStatus @default(FINALIZED)
  computed_at           DateTime     @default(now())

  @@unique([user_id, actor_type, year, month])
  @@index([year, month, performance_index])
}

model MonthlyBonusLedger {
  id              String      @id @default(cuid())
  driver_user_id  String
  year            Int
  month           Int
  bonus_type      BonusType
  discount_bps    Int
  reason          String
  status          BonusStatus @default(ACTIVE)
  starts_at       DateTime
  ends_at         DateTime
  created_at      DateTime    @default(now())

  @@unique([driver_user_id, year, month])
}

model CommissionPolicy {
  id         String   @id @default(cuid())
  key        String   @unique
  value_json Json
  updated_at DateTime @updatedAt
}



model ExternalTripPayment {
  id               String  @id
  trip_id          String  @unique
  amount_total     Int
  commission_amount Int
  driver_net_amount Int
  refunded_amount  Int     @default(0)
  status           String
  created_at       DateTime

  @@map("TripPayment")
}

model ExternalDriverProfile {
  id            String  @id
  user_id       String  @unique
  mp_account_id String?

  @@map("DriverProfile")
}


model ClientFingerprint {
  id                      String    @id @default(cuid())
  user_id                 String
  actor_type              ActorType
  ip_hash                 String
  user_agent_hash         String
  device_fingerprint_hash String?
  created_at              DateTime  @default(now())

  @@index([ip_hash, created_at])
  @@index([device_fingerprint_hash, created_at])
}

model FraudSignal {
  id           String          @id @default(cuid())
  user_id      String?
  trip_id      String?
  payment_id   String?
  type         FraudSignalType
  severity     FraudSeverity
  score_delta  Int
  payload_json Json
  created_at   DateTime        @default(now())

  @@index([type, created_at])
  @@index([user_id, created_at])
}

model FraudCase {
  id                  String          @id @default(cuid())
  primary_user_id     String?
  status              FraudCaseStatus @default(OPEN)
  severity            FraudSeverity
  title               String
  summary             String
  related_trip_ids    Json?
  related_user_ids    Json?
  related_payment_ids Json?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  assigned_to_user_id String?
  last_signal_at      DateTime?

  links FraudCaseSignalLink[]

  @@index([status, severity, created_at])
}

model FraudCaseSignalLink {
  id              String   @id @default(cuid())
  fraud_case_id   String
  fraud_signal_id String
  created_at      DateTime @default(now())

  fraud_case FraudCase @relation(fields: [fraud_case_id], references: [id], onDelete: Cascade)

  @@unique([fraud_case_id, fraud_signal_id])
}

model FinancialRiskScore {
  id         String   @id @default(cuid())
  user_id    String   @unique
  score      Int      @default(0)
  level      String   @default("LOW")
  updated_at DateTime @updatedAt
}

model UserHold {
  id                 String     @id @default(cuid())
  user_id            String
  hold_type          HoldType
  status             HoldStatus @default(ACTIVE)
  reason             String
  starts_at          DateTime
  ends_at            DateTime?
  created_by_user_id String?
  payload_json       Json
  created_at         DateTime   @default(now())

  @@index([user_id, status])
}
